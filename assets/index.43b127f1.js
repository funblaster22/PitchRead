import{S as D,i as G,s as q,c as Q,e as M,a as k,b as w,u as Z,g as ee,d as te,t as T,f as ne,h as oe,j as F,k as se,l as C,m as z,n as ie,o as _,p as re,q as ae,V as le,r as ce,v as V,w as P,x as H,y as A,z as ue,A as de,B as $,C as N,D as fe,E as me,F as he}from"./vendor.2f21e7bd.js";const pe=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function n(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerpolicy&&(i.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?i.credentials="include":t.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(t){if(t.ep)return;t.ep=!0;const i=n(t);fetch(t.href,i)}};pe();function ge(s){let e,n,o,t;const i=s[2].default,r=Q(i,s,s[1],null);return{c(){e=M("div"),r&&r.c(),k(e,"id","card"),k(e,"class","svelte-bkkv88")},m(l,a){w(l,e,a),r&&r.m(e,null),t=!0},p(l,[a]){r&&r.p&&(!t||a&2)&&Z(r,i,l,l[1],t?te(i,l[1],a,null):ee(l[1]),null)},i(l){t||(T(r,l),ne(()=>{o&&o.end(1),n=oe(e,z,{x:200,duration:500,delay:500}),n.start()}),t=!0)},o(l){F(r,l),n&&n.invalidate(),o=se(e,z,{x:-200,duration:500}),t=!1},d(l){l&&C(e),r&&r.d(l),l&&o&&o.end()}}}function _e(s,e,n){let{$$slots:o={},$$scope:t}=e,{definition:i="definition"}=e;return s.$$set=r=>{"definition"in r&&n(0,i=r.definition),"$$scope"in r&&n(1,t=r.$$scope)},[i,t,o]}class ve extends D{constructor(e){super();G(this,e,_e,ge,q,{definition:0})}}class ye{constructor(e){this.middleA=e||440,this.semitone=69,this.bufferSize=4096,this.noteStrings=["C","C\u266F","D","D\u266F","E","F","F\u266F","G","G\u266F","A","A\u266F","B"],this.initGetUserMedia()}initGetUserMedia(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(e){const n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return n||alert("getUserMedia is not implemented in this browser"),new Promise(function(o,t){n.call(navigator,e,o,t)})})}startRecord(){const e=this;navigator.mediaDevices.getUserMedia({audio:!0}).then(function(n){e.audioContext.createMediaStreamSource(n).connect(e.analyser),e.analyser.connect(e.scriptProcessor),e.scriptProcessor.connect(e.audioContext.destination),e.scriptProcessor.addEventListener("audioprocess",function(o){const t=e.pitchDetector.do(o.inputBuffer.getChannelData(0));if(t&&e.onNoteDetected){const i=e.getNote(t);e.onNoteDetected({name:e.noteStrings[i%12],value:i,cents:e.getCents(t,i),octave:parseInt(i/12)-1,frequency:t})}})}).catch(function(n){alert(n.name+": "+n.message)})}init(){this.audioContext=new window.AudioContext,this.analyser=this.audioContext.createAnalyser(),this.scriptProcessor=this.audioContext.createScriptProcessor(this.bufferSize,1,1);const e=this;ie().then(n=>{e.pitchDetector=new n.Pitch("default",e.bufferSize,1,e.audioContext.sampleRate),e.startRecord()})}getNote(e){const n=12*(Math.log(e/this.middleA)/Math.log(2));return Math.round(n)+this.semitone}getStandardFrequency(e){return this.middleA*Math.pow(2,(e-this.semitone)/12)}getCents(e,n){return Math.floor(1200*Math.log(e/this.getStandardFrequency(n))/Math.log(2))}play(e){this.oscillator||(this.oscillator=this.audioContext.createOscillator(),this.oscillator.connect(this.audioContext.destination),this.oscillator.start()),this.oscillator.frequency.value=e}stop(){this.oscillator.stop(),this.oscillator=null}onNoteDetected({name:e,value:n,cents:o,octave:t,frequency:i}){}}function we(s){let e;return{c(){e=M("div"),e.innerHTML='<g class="vf-stavenote" id="vf-auto8132"><g class="vf-note" pointer-events="bounding-box"><g class="vf-notehead" pointer-events="bounding-box"><path stroke-width="0.3" fill="black" stroke="none" stroke-dasharray="none" d="M453 105M453 104.91576C453 107.63952,455.30256 110.0544,461.33976 110.0544C467.96664 110.0544,470.07264 107.75184,470.07264 104.91576C470.07264 102.0516,465.4956 99.9456,461.73288 99.9456C456.3696 99.9456,453 102.16392,453 104.91576M457.38048 103.42752C457.38048 103.09056,457.40856 102.78168,457.4928 102.44472C457.94208 101.04072,459.43032 100.84416,460.69392 100.84416C463.47384 100.84416,465.69216 103.82064,465.69216 106.2636C465.69216 107.49912,465.15864 108.6504,463.83888 108.95928C463.44576 109.0716,462.99648 109.12776,462.57528 109.12776C461.11512 109.12776,459.62688 108.14496,458.78448 107.02176C457.97016 106.09512,457.38048 104.7192,457.38048 103.42752"></path></g></g><g class="vf-modifiers"></g></g>',k(e,"id","staff")},m(n,o){w(n,e,o),s[7](e)},p:_,i:_,o:_,d(n){n&&C(e),s[7](null)}}}function Ce(s,e,n){let o,{currentPitch:t}=e,{transpose:i=0}=e,{events:r}=e,{paused:l=!0}=e;localStorage.score||(localStorage.score=0);let a=localStorage.score,c;re(()=>{const u=le.Flow,b=new u.Renderer(o,u.Renderer.Backends.SVG);b.resize(401,125);const f=b.getContext(),h=new u.TickContext,v=new u.TickContext,S=new u.Stave(10,10,1e4).addClef("treble");S.setContext(f).draw();const E=["8","4","2","1"];function K([g,p,y]){console.log(`${g}${p}/${y}`);const m=new u.StaveNote({clef:"treble",keys:[`${g}${p}/${y}`],duration:E[Math.floor(Math.random()*E.length)]}).setContext(f).setStave(S);return p&&m.addAccidental(0,new u.Accidental(p)),h.addTickable(m),h.preFormat().setX(400),m}const U=[],O=new u.StaveNote({clef:"treble",keys:["a/4"],duration:"1"}).setContext(f).setStave(S);v.addTickable(O),v.preFormat().setX(0),n(6,c=f.openGroup()),O.draw(),f.closeGroup(),c.classList.add("playingNote");const x=[];function X(){const g=["b","","#"][Math.floor(Math.random()*5)],p=[(Math.floor(Math.random()*7)+10).toString(36),g,Math.floor(Math.random()*2)+4];U.push(K(p));const y=U.shift();if(!y)return;const m=f.openGroup();x.push(m),y.draw(),f.closeGroup(),m.dataset.notename=p[0]+p[1]+"/"+p[2],m.classList.add("scroll"),m.getBoundingClientRect(),m.classList.add("scrolling"),window.setTimeout(()=>{x.indexOf(m)!==-1&&(m.classList.add("too-slow"),x.shift(),setTimeout(()=>m.remove(),5e3))},5e3)}function W(){const g=x.shift();g.classList.add("correct");const y=window.getComputedStyle(g).transform.split(",")[4].trim();g.style.transform=`translate(${y}px, -800px)`,fetch(`/scores/add?user=${localStorage.name}&score=${n(5,++a)}`),setTimeout(()=>g.remove(),5e3)}function I(){var g,p,y,m,L;console.log("CHECKING",(p=(g=x[0])==null?void 0:g.dataset)==null?void 0:p.notename),((y=t==null?void 0:t.name)==null?void 0:y.toLowerCase())+"/"+t.octave===((L=(m=x[0])==null?void 0:m.dataset)==null?void 0:L.notename)&&W(),requestAnimationFrame(I)}I();let R;r.addEventListener("resume",Y);function Y(){R=window.setInterval(X,1e3)}r.addEventListener("pause",J);function J(){clearInterval(R)}});function d(u){ae[u?"unshift":"push"](()=>{o=u,n(0,o)})}return s.$$set=u=>{"currentPitch"in u&&n(1,t=u.currentPitch),"transpose"in u&&n(2,i=u.transpose),"events"in u&&n(3,r=u.events),"paused"in u&&n(4,l=u.paused)},s.$$.update=()=>{s.$$.dirty&32&&(localStorage.score=a),s.$$.dirty&70&&c&&n(6,c.style.transform="translateY("+(69-t.value+i)*2.5+"px)",c),s.$$.dirty&2&&console.log(t)},[o,t,i,r,l,a,c,d]}class be extends D{constructor(e){super();G(this,e,Ce,we,q,{currentPitch:1,transpose:2,events:3,paused:4})}}function B(s,e,n){const o=s.slice();return o[7]=e[n],o}function ke(s){let e,n;return e=new be({props:{a4:440,currentPitch:s[0],events:s[2]}}),{c(){V(e.$$.fragment)},m(o,t){H(e,o,t),n=!0},p(o,t){const i={};t&1&&(i.currentPitch=o[0]),e.$set(i)},i(o){n||(T(e.$$.fragment,o),n=!0)},o(o){F(e.$$.fragment,o),n=!1},d(o){$(e,o)}}}function Me(s){return{c:_,m:_,p:_,d:_}}function Se(s){let e,n,o,t=[],i=new Map,r=Object.entries(s[6]);const l=a=>a[7][0];for(let a=0;a<r.length;a+=1){let c=B(s,r,a),d=l(c);i.set(d,t[a]=j(d,c))}return{c(){e=M("h3"),e.textContent="High Scores (using Linux server)",n=P(),o=M("ol");for(let a=0;a<t.length;a+=1)t[a].c()},m(a,c){w(a,e,c),w(a,n,c),w(a,o,c);for(let d=0;d<t.length;d+=1)t[d].m(o,null)},p(a,c){c&0&&(r=Object.entries(a[6]),t=fe(t,c,l,1,a,r,i,o,he,j,null,B))},d(a){a&&C(e),a&&C(n),a&&C(o);for(let c=0;c<t.length;c+=1)t[c].d()}}}function j(s,e){let n,o=e[7][0]+"",t,i,r=e[7][1]+"",l;return{key:s,first:null,c(){n=M("li"),t=N(o),i=N(": "),l=N(r),this.first=n},m(a,c){w(a,n,c),A(n,t),A(n,i),A(n,l)},p(a,c){e=a},d(a){a&&C(n)}}}function xe(s){return{c:_,m:_,p:_,d:_}}function Ae(s){let e,n=s[1]+1+"",o;return{c(){e=N("Resuming in "),o=N(n)},m(t,i){w(t,e,i),w(t,o,i)},p(t,i){i&2&&n!==(n=t[1]+1+"")&&me(o,n)},d(t){t&&C(e),t&&C(o)}}}function Ne(s){let e;return{c(){e=N("Paused. Click to resume.")},m(n,o){w(n,e,o)},p:_,d(n){n&&C(e)}}}function Le(s){let e,n,o,t,i,r,l,a,c;n=new ve({props:{$$slots:{default:[ke]},$$scope:{ctx:s}}});let d={ctx:s,current:null,token:null,hasCatch:!1,pending:xe,then:Se,catch:Me,value:6};ce(fetch("/scores").then(Pe),d);function u(h,v){return h[1]===3?Ne:Ae}let b=u(s),f=b(s);return{c(){e=M("main"),V(n.$$.fragment),o=P(),t=M("div"),d.block.c(),i=P(),f.c(),k(t,"class","overlay perfect-center svelte-q3mo76"),k(t,"style",r=`display:${s[1]===-1?"none":""}`),k(e,"class","perfect-center svelte-q3mo76")},m(h,v){w(h,e,v),H(n,e,null),A(e,o),A(e,t),d.block.m(t,d.anchor=null),d.mount=()=>t,d.anchor=i,A(t,i),f.m(t,null),l=!0,a||(c=ue(t,"click",s[3]),a=!0)},p(h,[v]){s=h;const S={};v&1025&&(S.$$scope={dirty:v,ctx:s}),n.$set(S),de(d,s,v),b===(b=u(s))&&f?f.p(s,v):(f.d(1),f=b(s),f&&(f.c(),f.m(t,null))),(!l||v&2&&r!==(r=`display:${s[1]===-1?"none":""}`))&&k(t,"style",r)},i(h){l||(T(n.$$.fragment,h),l=!0)},o(h){F(n.$$.fragment,h),l=!1},d(h){h&&C(e),$(n),d.block.d(),d.token=null,d=null,f.d(),a=!1,c()}}}const Pe=s=>s.json();function De(s,e,n){const o=new ye(440);let t=440;o.onNoteDetected=c=>n(0,t=c);const i=new EventTarget;let r=3;localStorage.name||(localStorage.name=prompt("What is your name? (will appear on online leaderboards)"));async function l(){return new Promise(c=>{n(1,r--,r)>0?(console.log(r),setTimeout(async()=>c(await l()),1e3)):c()})}async function a(){await l(),o.init(),i.dispatchEvent(new Event("resume"))}return[t,r,i,a]}class Ge extends D{constructor(e){super();G(this,e,De,Le,q,{})}}new Ge({target:document.body});
