import{S as P,i as T,s as q,c as ee,e as M,a as S,b as y,u as te,g as ne,d as oe,t as E,f as se,h as ie,j as F,k as ae,l as w,m as B,n as re,o as v,p as le,F as k,q as ce,r as ue,v as X,w as G,x as V,y as N,z as de,A as fe,B as W,C as A,D as me,E as pe,G as he}from"./vendor.3b8b406b.js";const ge=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerpolicy&&(i.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?i.credentials="include":t.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(t){if(t.ep)return;t.ep=!0;const i=n(t);fetch(t.href,i)}};ge();function _e(s){let e,n,o,t;const i=s[2].default,a=ee(i,s,s[1],null);return{c(){e=M("div"),a&&a.c(),S(e,"id","card"),S(e,"class","svelte-bkkv88")},m(l,r){y(l,e,r),a&&a.m(e,null),t=!0},p(l,[r]){a&&a.p&&(!t||r&2)&&te(a,i,l,l[1],t?oe(i,l[1],r,null):ne(l[1]),null)},i(l){t||(E(a,l),se(()=>{o&&o.end(1),n=ie(e,B,{x:200,duration:500,delay:500}),n.start()}),t=!0)},o(l){F(a,l),n&&n.invalidate(),o=ae(e,B,{x:-200,duration:500}),t=!1},d(l){l&&w(e),a&&a.d(l),l&&o&&o.end()}}}function ve(s,e,n){let{$$slots:o={},$$scope:t}=e,{definition:i="definition"}=e;return s.$$set=a=>{"definition"in a&&n(0,i=a.definition),"$$scope"in a&&n(1,t=a.$$scope)},[i,t,o]}class be extends P{constructor(e){super();T(this,e,ve,_e,q,{definition:0})}}class ye{constructor(e){this.middleA=e||440,this.semitone=69,this.bufferSize=4096,this.noteStrings=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this.initGetUserMedia()}initGetUserMedia(){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return alert("AudioContext not supported");navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(e){const n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return n||alert("getUserMedia is not implemented in this browser"),new Promise(function(o,t){n.call(navigator,e,o,t)})})}startRecord(){const e=this;navigator.mediaDevices.getUserMedia({audio:!0}).then(function(n){e.audioContext.createMediaStreamSource(n).connect(e.analyser),e.analyser.connect(e.scriptProcessor),e.scriptProcessor.connect(e.audioContext.destination),e.scriptProcessor.addEventListener("audioprocess",function(o){const t=e.pitchDetector.do(o.inputBuffer.getChannelData(0));if(t&&e.onNoteDetected){const i=e.getNote(t);e.onNoteDetected({name:e.noteStrings[i%12],value:i,cents:e.getCents(t,i),octave:parseInt(i/12)-1,frequency:t})}})}).catch(function(n){alert(n.name+": "+n.message)})}init(){this.audioContext=new window.AudioContext,this.analyser=this.audioContext.createAnalyser(),this.scriptProcessor=this.audioContext.createScriptProcessor(this.bufferSize,1,1);const e=this;re().then(n=>{e.pitchDetector=new n.Pitch("default",e.bufferSize,1,e.audioContext.sampleRate),e.startRecord()})}getNote(e){const n=12*(Math.log(e/this.middleA)/Math.log(2));return Math.round(n)+this.semitone}getStandardFrequency(e){return this.middleA*Math.pow(2,(e-this.semitone)/12)}getCents(e,n){return Math.floor(1200*Math.log(e/this.getStandardFrequency(n))/Math.log(2))}play(e){this.oscillator||(this.oscillator=this.audioContext.createOscillator(),this.oscillator.connect(this.audioContext.destination),this.oscillator.start()),this.oscillator.frequency.value=e}stop(){this.oscillator.stop(),this.oscillator=null}onNoteDetected({name:e,value:n,cents:o,octave:t,frequency:i}){}}function we(s){let e;return{c(){e=M("div"),e.innerHTML='<g class="vf-stavenote" id="vf-auto8132"><g class="vf-note" pointer-events="bounding-box"><g class="vf-notehead" pointer-events="bounding-box"><path stroke-width="0.3" fill="black" stroke="none" stroke-dasharray="none" d="M453 105M453 104.91576C453 107.63952,455.30256 110.0544,461.33976 110.0544C467.96664 110.0544,470.07264 107.75184,470.07264 104.91576C470.07264 102.0516,465.4956 99.9456,461.73288 99.9456C456.3696 99.9456,453 102.16392,453 104.91576M457.38048 103.42752C457.38048 103.09056,457.40856 102.78168,457.4928 102.44472C457.94208 101.04072,459.43032 100.84416,460.69392 100.84416C463.47384 100.84416,465.69216 103.82064,465.69216 106.2636C465.69216 107.49912,465.15864 108.6504,463.83888 108.95928C463.44576 109.0716,462.99648 109.12776,462.57528 109.12776C461.11512 109.12776,459.62688 108.14496,458.78448 107.02176C457.97016 106.09512,457.38048 104.7192,457.38048 103.42752"></path></g></g><g class="vf-modifiers"></g></g>',S(e,"id","staff")},m(n,o){y(n,e,o),s[7](e)},p:v,i:v,o:v,d(n){n&&w(e),s[7](null)}}}function j(s){if(!s)return;const e=s.split("/")[0],n=Number.parseInt(s.at(-1));return({cb:"b",db:"c#",eb:"d#",fb:"e",gb:"f#",ab:"g#",bb:"a#"}[e]||e)+"/"+(e==="cb"?n-1:n)}function Ce(s,e,n){let o,{currentPitch:t}=e,{transpose:i=0}=e,{events:a}=e,{paused:l=!0}=e;localStorage.score||(localStorage.score=0);let r=localStorage.score,c;le(()=>{const d=new k.Renderer(o,k.Renderer.Backends.SVG);d.resize(401,125);const h=d.getContext(),p=new k.TickContext,m=new k.TickContext,g=new k.Stave(10,10,1e4).addClef("treble");g.setContext(h).draw();const L=["8","4","2","1"];function Y([b,_,C]){const f=new k.StaveNote({clef:"treble",keys:[`${b}${_}/${C}`],duration:L[Math.floor(Math.random()*L.length)]}).setContext(h).setStave(g);return _&&f.addModifier(new k.Accidental(_)),p.addTickable(f),p.preFormat().setX(400),f}const U=[],I=new k.StaveNote({clef:"treble",keys:["a/4"],duration:"1"}).setContext(h).setStave(g);m.addTickable(I),m.preFormat().setX(0),n(6,c=h.openGroup()),I.draw(),h.closeGroup(),c.classList.add("playingNote");const x=[];function J(){const b=["b","","#"][Math.floor(Math.random()*3)],_=[(Math.floor(Math.random()*7)+10).toString(36),b,Math.floor(Math.random()*2)+4];U.push(Y(_));const C=U.shift();if(!C)return;const f=h.openGroup();x.push(f),C.draw(),h.closeGroup(),f.dataset.notename=_[0]+_[1]+"/"+_[2],f.classList.add("scroll"),f.getBoundingClientRect(),f.classList.add("scrolling"),window.setTimeout(()=>{x.indexOf(f)!==-1&&(f.classList.add("too-slow"),x.shift(),setTimeout(()=>f.remove(),5e3))},5e3)}function Q(){const b=x.shift();b.classList.add("correct");const C=window.getComputedStyle(b).transform.split(",")[4].trim();b.style.transform=`translate(${C}px, -800px)`,fetch(`/scores/add?user=${localStorage.name}&score=${n(5,++r)}`),setTimeout(()=>b.remove(),5e3)}function O(){var b,_,C,f,D,z;console.log("CHECKING",j((_=(b=x[0])==null?void 0:b.dataset)==null?void 0:_.notename),"against",((C=t==null?void 0:t.name)==null?void 0:C.toLowerCase())+"/"+t.octave),((f=t==null?void 0:t.name)==null?void 0:f.toLowerCase())+"/"+t.octave===j((z=(D=x[0])==null?void 0:D.dataset)==null?void 0:z.notename)&&Q(),requestAnimationFrame(O)}O();let R;a.addEventListener("resume",Z);function Z(){R=window.setInterval(J,1e3)}a.addEventListener("pause",$);function $(){clearInterval(R)}});function u(d){ce[d?"unshift":"push"](()=>{o=d,n(0,o)})}return s.$$set=d=>{"currentPitch"in d&&n(1,t=d.currentPitch),"transpose"in d&&n(2,i=d.transpose),"events"in d&&n(3,a=d.events),"paused"in d&&n(4,l=d.paused)},s.$$.update=()=>{s.$$.dirty&32&&(localStorage.score=r),s.$$.dirty&70&&c&&n(6,c.style.transform="translateY("+(69-t.value+i)*2.5+"px)",c)},[o,t,i,a,l,r,c,u]}class ke extends P{constructor(e){super();T(this,e,Ce,we,q,{currentPitch:1,transpose:2,events:3,paused:4})}}function H(s,e,n){const o=s.slice();return o[7]=e[n],o}function Se(s){let e,n;return e=new ke({props:{a4:440,currentPitch:s[0],events:s[2]}}),{c(){X(e.$$.fragment)},m(o,t){V(e,o,t),n=!0},p(o,t){const i={};t&1&&(i.currentPitch=o[0]),e.$set(i)},i(o){n||(E(e.$$.fragment,o),n=!0)},o(o){F(e.$$.fragment,o),n=!1},d(o){W(e,o)}}}function Me(s){return{c:v,m:v,p:v,d:v}}function xe(s){let e,n,o,t=[],i=new Map,a=Object.entries(s[6]);const l=r=>r[7][0];for(let r=0;r<a.length;r+=1){let c=H(s,a,r),u=l(c);i.set(u,t[r]=K(u,c))}return{c(){e=M("h3"),e.textContent="High Scores (using Linux server)",n=G(),o=M("ol");for(let r=0;r<t.length;r+=1)t[r].c()},m(r,c){y(r,e,c),y(r,n,c),y(r,o,c);for(let u=0;u<t.length;u+=1)t[u].m(o,null)},p(r,c){c&0&&(a=Object.entries(r[6]),t=me(t,c,l,1,r,a,i,o,he,K,null,H))},d(r){r&&w(e),r&&w(n),r&&w(o);for(let c=0;c<t.length;c+=1)t[c].d()}}}function K(s,e){let n,o=e[7][0]+"",t,i,a=e[7][1]+"",l;return{key:s,first:null,c(){n=M("li"),t=A(o),i=A(": "),l=A(a),this.first=n},m(r,c){y(r,n,c),N(n,t),N(n,i),N(n,l)},p(r,c){e=r},d(r){r&&w(n)}}}function Ne(s){return{c:v,m:v,p:v,d:v}}function Ae(s){let e,n=s[1]+1+"",o;return{c(){e=A("Resuming in "),o=A(n)},m(t,i){y(t,e,i),y(t,o,i)},p(t,i){i&2&&n!==(n=t[1]+1+"")&&pe(o,n)},d(t){t&&w(e),t&&w(o)}}}function Le(s){let e;return{c(){e=A("Paused. Click to resume.")},m(n,o){y(n,e,o)},p:v,d(n){n&&w(e)}}}function De(s){let e,n,o,t,i,a,l,r,c;n=new be({props:{$$slots:{default:[Se]},$$scope:{ctx:s}}});let u={ctx:s,current:null,token:null,hasCatch:!1,pending:Ne,then:xe,catch:Me,value:6};ue(fetch("/scores").then(Ge),u);function d(m,g){return m[1]===3?Le:Ae}let h=d(s),p=h(s);return{c(){e=M("main"),X(n.$$.fragment),o=G(),t=M("div"),u.block.c(),i=G(),p.c(),S(t,"class","overlay perfect-center svelte-q3mo76"),S(t,"style",a=`display:${s[1]===-1?"none":""}`),S(e,"class","perfect-center svelte-q3mo76")},m(m,g){y(m,e,g),V(n,e,null),N(e,o),N(e,t),u.block.m(t,u.anchor=null),u.mount=()=>t,u.anchor=i,N(t,i),p.m(t,null),l=!0,r||(c=de(t,"click",s[3]),r=!0)},p(m,[g]){s=m;const L={};g&1025&&(L.$$scope={dirty:g,ctx:s}),n.$set(L),fe(u,s,g),h===(h=d(s))&&p?p.p(s,g):(p.d(1),p=h(s),p&&(p.c(),p.m(t,null))),(!l||g&2&&a!==(a=`display:${s[1]===-1?"none":""}`))&&S(t,"style",a)},i(m){l||(E(n.$$.fragment,m),l=!0)},o(m){F(n.$$.fragment,m),l=!1},d(m){m&&w(e),W(n),u.block.d(),u.token=null,u=null,p.d(),r=!1,c()}}}const Ge=s=>s.json();function Pe(s,e,n){const o=new ye(440);let t=440;o.onNoteDetected=c=>n(0,t=c);const i=new EventTarget;let a=3;localStorage.name||(localStorage.name=prompt("What is your name? (will appear on online leaderboards)"));async function l(){return new Promise(c=>{n(1,a--,a)>0?(console.log(a),setTimeout(async()=>c(await l()),1e3)):c()})}async function r(){await l(),o.init(),i.dispatchEvent(new Event("resume"))}return[t,a,i,r]}class Te extends P{constructor(e){super();T(this,e,Pe,De,q,{})}}new Te({target:document.body});
